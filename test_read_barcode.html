<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>QR Scanner</title>
    <style>
      #video {
	  width: 100%;
	  max-width: 600px;
	  height: 750px;
	  border: 1px solid #ccc;
	  margin-top: 10px;
      }
      #start-btn {
	  font-size: 16px;
	  padding: 8px 16px;
      }
      #output {
	  margin-top: 10px;
	  font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h2>QR ã‚¹ã‚­ãƒ£ãƒŠ</h2>
    <button id="start-btn">ğŸ“· ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•</button>
    <video id='video' autoplay></video>
    <canvas id='canvas' hidden></canvas>
    <div id='output'>èª­ã¿å–ã‚Šçµæœ: ãªã—</div>

    <script src='https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js'></script>
    <script>
      const startBtn = document.getElementById('start-btn');
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      const output = document.getElementById('output');
      const ctx = canvas.getContext('2d');

      let scanning = false;

      function log(msg) {
	  const logArea = document.getElementById('log') || (() => {
	      const div = document.createElement('div');
	      div.id = 'log';
	      div.style.whiteSpace = 'pre-wrap';
	      div.style.background = '#eee';
	      div.style.padding = '8px';
	      document.body.appendChild(div);
	      return div;
	  })();
	  logArea.textContent += msg +'\n';
      }

      startBtn.addEventListener('click', async() => {
	  if (scanning) return;
	  scanning = true;
	  try {
	      const stream = await navigator.mediaDevices.getUserMedia({ video: {facingMode: 'environment'}});
	      video.srcObject = stream;
	      video.setAttribute('playsinline', true);
	      requestAnimationFrame(scanFrame);
      } catch (err) {
	  alert('ã‚«ãƒ¡ãƒ©ã®èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ: '+err);
      }
      });

      function scanFrame() {
	  if (video.readyState === video.HAVE_ENOUGH_DATA) {
	      canvas.width = video.videoWidth;
	      canvas.height = video.videoHeight;
	      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

	      const imageData = ctx.getImageData(0, 0, canvas.width,canvas.height);
	      const code = jsQR(imageData.data, imageData.width, imageData.height);

	      if (code) {
		  output.textContent = 'èª­ã¿å–ã‚Šçµæœ: '+code.data;

		  fetch('https://script.google.com/macros/s/AKfycbyB7arT3032iqkYlEljBvn7Ah62i4OV-C4JQtpANxmZUhbkC0gAnOp0qju-F6GmgMXr/exec', {
		      method: 'POST',
		      headers: {'Content-Type': 'application/json'},
		      body: JSON.stringify({ text:code.data })
		  })
		      .then(response => response.text())
		      .then(result => log('é€ä¿¡æˆåŠŸ', result))
		  // .then(result => console.log('é€ä¿¡æˆåŠŸ', result))
		  // .catch(err => console.error('é€ä¿¡å¤±æ•—', err));
		      .catch(err => log('é€ä¿¡å¤±æ•—', err));
	      } else {
		  requestAnimationFrame(scanFrame);
	      }
	  } else {
	      requestAnimationFrame(scanFrame);
	  }
      }
    </script>
  </body>
</html>
